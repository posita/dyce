
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Simple Python tools for dice-based probabilities">
      
      
        <meta name="author" content="Matt Bogosian">
      
      
        <link rel="canonical" href="https://posita.github.io/dyce/0.6/dyce.evaluation/">
      
      
        <link rel="prev" href="../dyce/">
      
      
        <link rel="next" href="../dyce.h/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.21">
    
    
      
        <title>dyce.evaluation - dyce</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.eebd395e.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dyceevaluation-package-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="dyce" class="md-header__button md-logo" aria-label="dyce" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            dyce
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              <tt>dyce.evaluation</tt>
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/posita/dyce" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="dyce" class="md-nav__button md-logo" aria-label="dyce" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    dyce
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/posita/dyce" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../countin/" class="md-nav__link">
        Countin’ with histograms and pools
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../rollin/" class="md-nav__link">
        Rollin’ with rollers and rolls
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../translations/" class="md-nav__link">
        Applications and translations
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../notes/" class="md-nav__link">
        Release notes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../contrib/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dyce/" class="md-nav__link">
        <tt>dyce</tt>
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          <tt>dyce.evaluation</tt>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        <tt>dyce.evaluation</tt>
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dyce.evaluation.HResult" class="md-nav__link">
    HResult
  </a>
  
    <nav class="md-nav" aria-label="HResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dyce.evaluation.HResult.h" class="md-nav__link">
    h
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dyce.evaluation.HResult.outcome" class="md-nav__link">
    outcome
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dyce.evaluation.PResult" class="md-nav__link">
    PResult
  </a>
  
    <nav class="md-nav" aria-label="PResult">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dyce.evaluation.PResult.p" class="md-nav__link">
    p
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dyce.evaluation.PResult.roll" class="md-nav__link">
    roll
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dyce.evaluation.PWithSelection" class="md-nav__link">
    PWithSelection
  </a>
  
    <nav class="md-nav" aria-label="PWithSelection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dyce.evaluation.PWithSelection.p" class="md-nav__link">
    p
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dyce.evaluation.PWithSelection.total" class="md-nav__link">
    total
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dyce.evaluation.PWithSelection.which" class="md-nav__link">
    which
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dyce.evaluation.aggregate_weighted" class="md-nav__link">
    aggregate_weighted()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dyce.evaluation.expandable" class="md-nav__link">
    expandable()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dyce.evaluation.explode" class="md-nav__link">
    explode()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dyce.evaluation.foreach" class="md-nav__link">
    foreach()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dyce.h/" class="md-nav__link">
        <tt>dyce.h</tt>
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dyce.r/" class="md-nav__link">
        <tt>dyce.r</tt>
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<!---
  Copyright and other protections apply. Please see the accompanying LICENSE file for
  rights and restrictions governing use of this software. All rights not expressly
  waived or licensed are reserved. If that file is missing or appears to be modified
  from its original, then please contact the author before viewing or using this
  software in any capacity.

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  !!!!!!!!!!!!!!! IMPORTANT: READ THIS BEFORE EDITING! !!!!!!!!!!!!!!!
  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  Please keep each sentence on its own unwrapped line.
  It looks like crap in a text editor, but it has no effect on rendering, and it allows much more useful diffs.
  Thank you!
-->

<h1 id="dyceevaluation-package-reference"><code class="highlight"><span class="n">dyce</span><span class="o">.</span><span class="n">evaluation</span></code> package reference</h1>


<div class="doc doc-object doc-module">



  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="dyce.evaluation.HResult" class="doc doc-heading">
          <code>HResult</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>


            <details class="quote">
              <summary>Source code in <code>dyce/evaluation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">HResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">h</span><span class="p">:</span> <span class="n">H</span>
    <span class="n">outcome</span><span class="p">:</span> <span class="n">RealLike</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="dyce.evaluation.HResult.h" class="doc doc-heading">
<code class="highlight language-python"><span class="n">h</span><span class="p">:</span> <span class="n">H</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="dyce.evaluation.HResult.outcome" class="doc doc-heading">
<code class="highlight language-python"><span class="n">outcome</span><span class="p">:</span> <span class="n">RealLike</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="dyce.evaluation.PResult" class="doc doc-heading">
          <code>PResult</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>


            <details class="quote">
              <summary>Source code in <code>dyce/evaluation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">p</span><span class="p">:</span> <span class="n">P</span>
    <span class="n">roll</span><span class="p">:</span> <span class="n">RollT</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="dyce.evaluation.PResult.p" class="doc doc-heading">
<code class="highlight language-python"><span class="n">p</span><span class="p">:</span> <span class="n">P</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="dyce.evaluation.PResult.roll" class="doc doc-heading">
<code class="highlight language-python"><span class="n">roll</span><span class="p">:</span> <span class="n">RollT</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="dyce.evaluation.PWithSelection" class="doc doc-heading">
          <code>PWithSelection</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>


            <details class="quote">
              <summary>Source code in <code>dyce/evaluation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PWithSelection</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">p</span><span class="p">:</span> <span class="n">P</span>
    <span class="n">which</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_GetItemT</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">total</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="dyce.evaluation.PWithSelection.p" class="doc doc-heading">
<code class="highlight language-python"><span class="n">p</span><span class="p">:</span> <span class="n">P</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="dyce.evaluation.PWithSelection.total" class="doc doc-heading">
<code class="highlight language-python"><span class="n">total</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="dyce.evaluation.PWithSelection.which" class="doc doc-heading">
<code class="highlight language-python"><span class="n">which</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">_GetItemT</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>



<div class="doc doc-object doc-function">



<h2 id="dyce.evaluation.aggregate_weighted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">aggregate_weighted</span><span class="p">(</span><span class="n">weighted_sources</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">HOrOutcomeT</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">h_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">H</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Aggregates <em>weighted_sources</em> into an <a class="autorefs autorefs-internal" href="../dyce/#dyce.h.H"><code>H</code> object</a>. Each of
<em>weighted_sources</em> is a two-tuple of either an outcome-count pair or a
histogram-count pair. This function is used in the implementation of the
<a class="autorefs autorefs-internal" href="#dyce.evaluation.expandable"><code>expandable</code> decorator</a> and derivatives (like the
<a class="autorefs autorefs-internal" href="#dyce.evaluation.foreach"><code>foreach</code> function</a>) as well as the (deprecated)
<a class="autorefs autorefs-internal" href="../dyce/#dyce.h.H.substitute"><code>H.substitute</code></a> and <a class="autorefs autorefs-internal" href="../dyce/#dyce.p.P.foreach"><code>P.foreach</code></a>
methods. Unlike those, the histogram returned from this function is <em>not</em> reduced to
its lowest terms.</p>
<p>In nearly all cases, when a source contains a histogram, its total takes on the
corresponding count’s weight. In other words, the sum of the counts of the histogram
retains the same proportion to other outcomes as its corresponding count. This
becomes clearer when there is no overlap between the histogram and the other
outcomes.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce.evaluation</span> <span class="kn">import</span> <span class="n">aggregate_weighted</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">weighted_sources</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">}),</span> <span class="mi">2</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">aggregate_weighted</span><span class="p">(</span><span class="n">weighted_sources</span><span class="p">)</span><span class="o">.</span><span class="n">lowest_terms</span><span class="p">()</span> <span class="p">;</span> <span class="n">h</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">An important exception</p>
<p>If a source is the empty histogram (<code>H({})</code>), it and its count is omitted from
the result without scaling.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">weighted_sources</span> <span class="o">=</span> <span class="p">((</span><span class="n">H</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">H</span><span class="p">({}),</span> <span class="mi">20</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">aggregate_weighted</span><span class="p">(</span><span class="n">weighted_sources</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
</div>

          <details class="quote">
            <summary>Source code in <code>dyce/evaluation.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">aggregate_weighted</span><span class="p">(</span>
    <span class="n">weighted_sources</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">HOrOutcomeT</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
    <span class="n">h_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">H</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregates *weighted_sources* into an [``H`` object][dyce.h.H]. Each of</span>
<span class="sd">    *weighted_sources* is a two-tuple of either an outcome-count pair or a</span>
<span class="sd">    histogram-count pair. This function is used in the implementation of the</span>
<span class="sd">    [``expandable`` decorator][dyce.evaluation.expandable] and derivatives (like the</span>
<span class="sd">    [``foreach`` function][dyce.evaluation.foreach]) as well as the (deprecated)</span>
<span class="sd">    [``H.substitute``][dyce.h.H.substitute] and [``P.foreach``][dyce.p.P.foreach]</span>
<span class="sd">    methods. Unlike those, the histogram returned from this function is *not* reduced to</span>
<span class="sd">    its lowest terms.</span>

<span class="sd">    In nearly all cases, when a source contains a histogram, its total takes on the</span>
<span class="sd">    corresponding count’s weight. In other words, the sum of the counts of the histogram</span>
<span class="sd">    retains the same proportion to other outcomes as its corresponding count. This</span>
<span class="sd">    becomes clearer when there is no overlap between the histogram and the other</span>
<span class="sd">    outcomes.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from dyce.evaluation import aggregate_weighted</span>
<span class="sd">    &gt;&gt;&gt; weighted_sources = ((H({1: 1}), 1), (H({1: 1, 2: 2}), 2))</span>
<span class="sd">    &gt;&gt;&gt; h = aggregate_weighted(weighted_sources).lowest_terms() ; h</span>
<span class="sd">    H({1: 5, 2: 4})</span>

<span class="sd">    ```</span>

<span class="sd">    !!! note &quot;An important exception&quot;</span>

<span class="sd">        If a source is the empty histogram (``H({})``), it and its count is omitted from</span>
<span class="sd">        the result without scaling.</span>

<span class="sd">        ``` python</span>
<span class="sd">        &gt;&gt;&gt; weighted_sources = ((H(2), 1), (H({}), 20))</span>
<span class="sd">        &gt;&gt;&gt; aggregate_weighted(weighted_sources)</span>
<span class="sd">        H({1: 1, 2: 1})</span>

<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aggregate_scalar</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">outcome_counts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_OutcomeCountT</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">outcome_or_h</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">weighted_sources</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outcome_or_h</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">outcome_or_h</span><span class="p">:</span>
                <span class="n">h_scalar</span> <span class="o">=</span> <span class="n">outcome_or_h</span><span class="o">.</span><span class="n">total</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">prior_outcome</span><span class="p">,</span> <span class="n">prior_count</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outcome_counts</span><span class="p">):</span>
                    <span class="n">outcome_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">prior_outcome</span><span class="p">,</span> <span class="n">prior_count</span> <span class="o">*</span> <span class="n">h_scalar</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">new_outcome</span><span class="p">,</span> <span class="n">new_count</span> <span class="ow">in</span> <span class="n">outcome_or_h</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">outcome_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">new_outcome</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="n">aggregate_scalar</span> <span class="o">*</span> <span class="n">new_count</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">aggregate_scalar</span> <span class="o">*=</span> <span class="n">h_scalar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outcome_counts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">outcome_or_h</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="n">aggregate_scalar</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">h_type</span><span class="p">(</span><span class="n">outcome_counts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="dyce.evaluation.expandable" class="doc doc-heading">
<code class="highlight language-python"><span class="n">expandable</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DependentTermT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">:</span> <span class="n">H</span> <span class="o">=</span> <span class="n">_DEFAULT_SENTINEL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_DependentTermT</span><span class="p">],</span> <span class="n">_ForEachEvaluatorT</span><span class="p">],</span> <span class="n">_ForEachEvaluatorT</span><span class="p">]</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>This function should be considered experimental and may change or disappear in
future versions.</p>
</div>
<p>Calls <code class="highlight"><span class="n">dependent_term</span></code> for each set of outcomes from the product of any
independent sources provided to the decorated function and accumulates the results.
Independent sources are <a class="autorefs autorefs-internal" href="../dyce/#dyce.h.H"><code>H</code> objects</a>, <a class="autorefs autorefs-internal" href="../dyce/#dyce.p.P"><code>P</code> objects</a>, or
<a class="autorefs autorefs-internal" href="#dyce.evaluation.PWithSelection"><code>PWithSelection</code> wrapper objects</a>. Results are
passed to <code class="highlight"><span class="n">dependent_term</span></code> via
<a class="autorefs autorefs-internal" href="#dyce.evaluation.HResult"><code>HResult</code> objects</a> or
<a class="autorefs autorefs-internal" href="#dyce.evaluation.PResult"><code>PResult</code> objects</a>, corresponding to the respective
independent term. This is useful for resolving dependent probabilities. Returned
histograms are always reduced to their lowest terms.</p>
<p>For example, let’s say we’re rolling a d20 but want to re-roll a <code class="highlight"><span class="mi">1</span></code> if
it comes up, then keep the result.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce</span> <span class="kn">import</span> <span class="n">H</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce.evaluation</span> <span class="kn">import</span> <span class="n">HResult</span><span class="p">,</span> <span class="n">expandable</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nd">@expandable</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">reroll_on_one</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">h</span>
<span class="o">...</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">reroll_on_one</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">2</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
 <span class="mi">3</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
 <span class="mi">4</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
 <span class="o">...</span><span class="p">,</span>
 <span class="mi">18</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
 <span class="mi">19</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
 <span class="mi">20</span><span class="p">:</span> <span class="mi">21</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">reroll_on_one</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">7</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>When the decorated function returns an <a class="autorefs autorefs-internal" href="../dyce/#dyce.h.H"><code>H</code> object</a>, that histogram’s
outcomes are accumulated, but the counts retain their “scale” within the context of
the evaluation. This becomes clearer when there is no overlap between the evaluated
histogram and the other outcomes.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">d6</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d00</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">;</span> <span class="n">d00</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">70</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">80</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">90</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">d6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">d00</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># no outcomes in common</span>
<span class="kc">True</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nd">@expandable</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">roll_d00_on_one</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="c1"># If a 1 comes up when rolling the d6,</span>
<span class="o">...</span>   <span class="c1"># roll a d00 and take that result instead</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">d00</span> <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">d6_d00</span> <span class="o">=</span> <span class="n">roll_d00_on_one</span><span class="p">(</span><span class="n">d6</span><span class="p">)</span> <span class="p">;</span> <span class="n">d6_d00</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">2</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
 <span class="mi">3</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
 <span class="mi">4</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
 <span class="mi">5</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
 <span class="mi">6</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
 <span class="mi">10</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">20</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">30</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">40</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">50</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">60</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">70</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">80</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">90</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>Note that the sum of the outcomes’ counts from the d00 make up the same
proportion as the one’s outcome and count they replaced from the d6.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">Fraction</span><span class="p">(</span>
<span class="o">...</span>   <span class="nb">sum</span><span class="p">(</span><span class="n">count</span> <span class="k">for</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">d6_d00</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">d00</span><span class="p">),</span>
<span class="o">...</span>   <span class="n">d6_d00</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<span class="o">...</span> <span class="p">)</span>
<span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">d6</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d6</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
<span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>We can leverage this to compute distributions for an “exploding” die (i.e.,
re-rolling and adding when rolling its highest face).</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nd">@expandable</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">explode_once</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">h</span> <span class="o">+</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>
<span class="o">...</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_once</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_once</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
   <span class="mi">2</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
   <span class="o">...</span><span class="p">,</span>
   <span class="mi">18</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
   <span class="mi">19</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
   <span class="mi">21</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="mi">22</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="o">...</span><span class="p">,</span>
   <span class="mi">39</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="mi">40</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p><code class="highlight"><span class="nd">@expandable</span></code> functions can call themselves recursively. They take a
<em>limit</em> keyword argument to control when such recursion should stop. The decorator
itself takes an optional argument <em>sentinel</em>, which defines what is returned once
<em>limit</em> is reached (or a <code class="highlight"><span class="ne">RecursionError</span></code> is encountered, whichever comes
first). The default value for <em>sentinel</em> is <code class="highlight"><span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span></code> and the value
ascribed to <em>limit</em>, if not provided, is <code class="highlight"><span class="mi">1</span></code>.</p>
<p>If <em>limit</em> is a whole number, it defines the maximum recursive evaluation “depth”.
The way to express no recursion (i.e., merely return <em>sentinel</em>) is to set <em>limit</em>
to an integral value of <code class="highlight"><span class="mi">0</span></code>. An integral value of <code class="highlight"><span class="o">-</span><span class="mi">1</span></code> is
equivalent to setting it to <code class="highlight"><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span></code>.<sup id="dyce.evaluation.expandable--fnref:1"><a class="footnote-ref" href="#dyce.evaluation.expandable--fn:1">1</a></sup></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">explode_recursive</span><span class="p">(</span><span class="n">h</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="nd">@expandable</span><span class="p">(</span><span class="n">sentinel</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>  <span class="c1"># return the original histogram at the recursion limit</span>
<span class="o">...</span>   <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="k">else</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">explode_once</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>  <span class="c1"># return the sentinel without evaluation</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">exploded_d6_h</span> <span class="o">=</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="n">exploded_d6_h</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">2</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">3</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">4</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">5</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">7</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">8</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">9</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">10</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">11</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">13</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">14</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">15</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">16</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">17</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">18</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>If <em>limit</em> is a fractional value between zero and one, exclusive, recursion will
halt on any branch whose “contextual precision” is less than or equal to that value.
Recursion is attempted for all of the outcomes of a(n evaluated) histogram or none
of them. The contextual precision of a returned histogram is its proportion to the
whole.</p>
<p>The contextual precision of the original (or top-level) execution is <code class="highlight"><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></code> or <code class="highlight"><span class="mf">1.0</span></code>. A <em>limit</em> of either of those values would
theoretically ensure no substitution. Similarly, a fractional value for <em>limit</em> of
<code class="highlight"><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></code> or <code class="highlight"><span class="mf">0.0</span></code> would theoretically ensure there is
no limit. However, These expressions would likely lead to confusion because they
have different meanings than equivalent integral values for <em>limit</em>. This is why
fractional types with values equivalent to zero and one are not allowed.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="n">exploded_d6_h</span>
<span class="kc">True</span>
</code></pre></div></td></tr></table></div>
<p>While whole number <em>limit</em> values will always cut off recursion at a constant depth,
fractional <em>limit</em> values can skew results in favor of certain recursion branches.
This is easily demonstrated when examining “unfair” dice (i.e., those
disproportionately weighted toward particular faces).</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">19</span><span class="p">}),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">7600</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">7220</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">6859</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">130321</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># same depth</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">152000</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">7600</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">380</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">19</span><span class="p">}),</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">7600</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">7220</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">6859</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mi">130321</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode_recursive</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># same limit, different depth</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">380</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>Be aware that some recursions are guaranteed to result in maxing out the stack, even
with fractional values for <em>limit</em> that are very close to one. We can often guard
against this by short-circuiting recursion where we know the evaluated contextual
probabilities do not asymptotically approach zero (e.g., where an entire branch
reliably generates histograms with precisely one outcome).</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">guarded_explode</span><span class="p">(</span><span class="n">h</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="nd">@expandable</span><span class="p">(</span><span class="n">sentinel</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
<span class="o">...</span>   <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot explode a histogram with a single outcome&quot;</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">elif</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">):</span>
<span class="o">...</span>       <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>
<span class="o">...</span>     <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">guarded_explode</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">999_999</span><span class="p">,</span> <span class="mi">1_000_000</span><span class="p">))</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="o">...</span>
<span class="ne">ValueError</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">explode</span> <span class="n">a</span> <span class="n">histogram</span> <span class="k">with</span> <span class="n">a</span> <span class="n">single</span> <span class="n">outcome</span>
</code></pre></div></td></tr></table></div>
<p>We can also evaluate multiple independent sources. For example, let’s say we want to
understand when a d6 will beat each face on two d10s. We can use a nested function
to also allow for a penalty or bonus modifier to the d6.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce</span> <span class="kn">import</span> <span class="n">P</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce.evaluation</span> <span class="kn">import</span> <span class="n">PResult</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p_2d10</span> <span class="o">=</span> <span class="mi">2</span><span class="nd">@P</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">times_a_modded_d6_beats_two_d10s</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="nd">@expandable</span>
<span class="o">...</span>   <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">d6</span><span class="p">:</span> <span class="n">HResult</span><span class="p">,</span> <span class="n">p_2d10</span><span class="p">:</span> <span class="n">PResult</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">p_2d10</span><span class="o">.</span><span class="n">roll</span> <span class="k">if</span> <span class="n">outcome</span> <span class="o">&lt;</span> <span class="n">d6</span><span class="o">.</span><span class="n">outcome</span> <span class="o">+</span> <span class="n">mod</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">p_2d10</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s</span><span class="p">()</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">11</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s</span><span class="p">(</span><span class="n">mod</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s</span><span class="p">(</span><span class="n">mod</span><span class="o">=+</span><span class="mi">2</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">262</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">139</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>Now let’s say we want to introduce the concept of an “advantage” or “disadvantage”
to the above, meaning we roll an extra d10 that can further penalize or benefit us.
We <em>could</em> just roll 3d10 and look at the best or worst two of each roll.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p_3d10</span> <span class="o">=</span> <span class="mi">3</span><span class="nd">@P</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Advantage</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="o">...</span>   <span class="n">DISADVANTAGE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
<span class="o">...</span>   <span class="n">NORMAL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
<span class="o">...</span>   <span class="n">ADVANTAGE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">times_a_modded_d6_beats_two_d10s_w_adv_brute_force</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adv</span><span class="p">:</span> <span class="n">Advantage</span> <span class="o">=</span> <span class="n">Advantage</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="nd">@expandable</span>
<span class="o">...</span>   <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">d6</span><span class="p">:</span> <span class="n">HResult</span><span class="p">,</span> <span class="n">p_d10s</span><span class="p">:</span> <span class="n">PResult</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">adv</span> <span class="ow">is</span> <span class="n">Advantage</span><span class="o">.</span><span class="n">ADVANTAGE</span><span class="p">:</span>
<span class="o">...</span>       <span class="n">roll</span> <span class="o">=</span> <span class="n">p_d10s</span><span class="o">.</span><span class="n">roll</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># try to beat the worst two values</span>
<span class="o">...</span>     <span class="k">elif</span> <span class="n">adv</span> <span class="ow">is</span> <span class="n">Advantage</span><span class="o">.</span><span class="n">DISADVANTAGE</span><span class="p">:</span>
<span class="o">...</span>       <span class="n">roll</span> <span class="o">=</span> <span class="n">p_d10s</span><span class="o">.</span><span class="n">roll</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># try to beat the best two values</span>
<span class="o">...</span>     <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>       <span class="n">roll</span> <span class="o">=</span> <span class="n">p_d10s</span><span class="o">.</span><span class="n">roll</span>
<span class="o">...</span>     <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">roll</span> <span class="k">if</span> <span class="n">outcome</span> <span class="o">&lt;</span> <span class="n">d6</span><span class="o">.</span><span class="n">outcome</span> <span class="o">+</span> <span class="n">mod</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="k">if</span> <span class="n">adv</span> <span class="ow">is</span> <span class="n">Advantage</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">p_2d10</span><span class="p">)</span>
<span class="o">...</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">p_3d10</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s_w_adv_brute_force</span><span class="p">()</span> <span class="o">==</span> <span class="n">times_a_modded_d6_beats_two_d10s</span><span class="p">()</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s_w_adv_brute_force</span><span class="p">(</span><span class="n">adv</span><span class="o">=</span><span class="n">Advantage</span><span class="o">.</span><span class="n">ADVANTAGE</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s_w_adv_brute_force</span><span class="p">(</span><span class="n">adv</span><span class="o">=</span><span class="n">Advantage</span><span class="o">.</span><span class="n">DISADVANTAGE</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>However, we could be more computationally more efficient by narrowing our selection
before we get to our evaluation function. We do this using
<a class="autorefs autorefs-internal" href="#dyce.evaluation.PWithSelection"><code>PWithSelection</code> objects</a> whose <code class="highlight"><span class="n">PWithSelection</span><span class="o">.</span><span class="n">which</span></code> values are passed to the
<a class="autorefs autorefs-internal" href="../dyce/#dyce.p.P.rolls_with_counts"><code>P.rolls_with_counts</code></a> method when enumerating the
rolls.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce.evaluation</span> <span class="kn">import</span> <span class="n">PWithSelection</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">times_a_modded_d6_beats_two_d10s_w_adv</span><span class="p">(</span><span class="n">mod</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adv</span><span class="p">:</span> <span class="n">Advantage</span> <span class="o">=</span> <span class="n">Advantage</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="nd">@expandable</span>
<span class="o">...</span>   <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">d6</span><span class="p">:</span> <span class="n">HResult</span><span class="p">,</span> <span class="n">p_d10s</span><span class="p">:</span> <span class="n">PResult</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">p_d10s</span><span class="o">.</span><span class="n">roll</span> <span class="k">if</span> <span class="n">outcome</span> <span class="o">&lt;</span> <span class="n">d6</span><span class="o">.</span><span class="n">outcome</span> <span class="o">+</span> <span class="n">mod</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="k">if</span> <span class="n">adv</span> <span class="ow">is</span> <span class="n">Advantage</span><span class="o">.</span><span class="n">ADVANTAGE</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">PWithSelection</span><span class="p">(</span><span class="n">p_3d10</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>  <span class="c1"># pass only the worst two values</span>
<span class="o">...</span>   <span class="k">elif</span> <span class="n">adv</span> <span class="ow">is</span> <span class="n">Advantage</span><span class="o">.</span><span class="n">DISADVANTAGE</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">PWithSelection</span><span class="p">(</span><span class="n">p_3d10</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>  <span class="c1"># pass only the best two values</span>
<span class="o">...</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">p_2d10</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s_w_adv</span><span class="p">()</span> <span class="o">==</span> <span class="n">times_a_modded_d6_beats_two_d10s</span><span class="p">()</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s_w_adv</span><span class="p">(</span><span class="n">adv</span><span class="o">=</span><span class="n">Advantage</span><span class="o">.</span><span class="n">ADVANTAGE</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">times_a_modded_d6_beats_two_d10s_w_adv</span><span class="p">(</span><span class="n">adv</span><span class="o">=</span><span class="n">Advantage</span><span class="o">.</span><span class="n">DISADVANTAGE</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>This function uses the <a class="autorefs autorefs-internal" href="#dyce.evaluation.aggregate_weighted"><code>aggregate_weighted</code></a>
function in its implementation. As such, if the empty histogram (<code>H({})</code>) is
returned at any point, the corresponding branch and its count is omitted from the
result without substitution or scaling. A silly example is modeling a d5 by
indefinitely re-rolling a d6 until something other than a 6 comes up.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nd">@expandable</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">omit_6s</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">H</span><span class="p">({})</span> <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">6</span> <span class="k">else</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">omit_6s</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>This technique is more useful when modeling re-rolling certain derived outcomes,
like ties in a contest.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nd">@expandable</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">vs</span><span class="p">(</span><span class="n">attack</span><span class="p">:</span> <span class="n">HResult</span><span class="p">,</span> <span class="n">defend</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="k">return</span> <span class="p">(</span><span class="n">attack</span><span class="o">.</span><span class="n">outcome</span> <span class="o">&gt;</span> <span class="n">defend</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">attack</span><span class="o">.</span><span class="n">outcome</span> <span class="o">&lt;</span> <span class="n">defend</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">vs</span><span class="p">(</span><span class="mi">3</span><span class="nd">@H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="mi">2</span><span class="nd">@H</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">4553</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1153</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">8118</span><span class="p">})</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nd">@expandable</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">vs_reroll_ties</span><span class="p">(</span><span class="n">attack</span><span class="p">:</span> <span class="n">HResult</span><span class="p">,</span> <span class="n">defend</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">attack</span><span class="o">.</span><span class="n">outcome</span> <span class="o">&gt;</span> <span class="n">defend</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">attack</span><span class="o">.</span><span class="n">outcome</span> <span class="o">&lt;</span> <span class="n">defend</span><span class="o">.</span><span class="n">outcome</span><span class="p">)</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">H</span><span class="p">({})</span> <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">res</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">vs_reroll_ties</span><span class="p">(</span><span class="mi">3</span><span class="nd">@H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="mi">2</span><span class="nd">@H</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">4553</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">8118</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>Expandables are quite flexible and well suited to modeling logical progressions with
dependent variables. Consider the following mechanic:</p>
<ol>
<li>
<p>Start with a total of zero.</p>
</li>
<li>
<p>Roll a six-sided die. If the face was a six, go to step 3. Otherwise, add the
     face to the total and stop.</p>
</li>
<li>
<p>Roll a four-sided die. Add the face to the total. If the face was a one, go to
     step 2. Otherwise, stop.</p>
</li>
</ol>
<p>What is the likelihood of an even final tally? This can be approximated by:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">alternating_d6_d4_mechanic</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="o">...</span>   <span class="n">d4</span><span class="p">,</span> <span class="n">d6</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="nd">@expandable</span>
<span class="o">...</span>   <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">h</span> <span class="o">==</span> <span class="n">d6</span> <span class="ow">and</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">d4</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">elif</span> <span class="n">h_result</span><span class="o">.</span><span class="n">h</span> <span class="o">==</span> <span class="n">d4</span> <span class="ow">and</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">+</span> <span class="n">_expand</span><span class="p">(</span><span class="n">d6</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">d6</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">alternating_d6_d4_mechanic</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5_000</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">avg</span> <span class="o">|</span>    <span class="mf">3.04</span>
<span class="n">std</span> <span class="o">|</span>    <span class="mf">1.37</span>
<span class="n">var</span> <span class="o">|</span>    <span class="mf">1.87</span>
  <span class="mi">1</span> <span class="o">|</span>  <span class="mf">16.67</span><span class="o">%</span> <span class="o">|</span><span class="c1">######################################</span>
  <span class="mi">2</span> <span class="o">|</span>  <span class="mf">21.53</span><span class="o">%</span> <span class="o">|</span><span class="c1">#################################################</span>
  <span class="mi">3</span> <span class="o">|</span>  <span class="mf">21.74</span><span class="o">%</span> <span class="o">|</span><span class="c1">##################################################</span>
  <span class="mi">4</span> <span class="o">|</span>  <span class="mf">21.74</span><span class="o">%</span> <span class="o">|</span><span class="c1">##################################################</span>
  <span class="mi">5</span> <span class="o">|</span>  <span class="mf">17.57</span><span class="o">%</span> <span class="o">|</span><span class="c1">########################################</span>
  <span class="mi">6</span> <span class="o">|</span>   <span class="mf">0.73</span><span class="o">%</span> <span class="o">|</span><span class="c1">#</span>
  <span class="mi">7</span> <span class="o">|</span>   <span class="mf">0.03</span><span class="o">%</span> <span class="o">|</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h_even</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">is_even</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h_even</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">h_even</span><span class="o">.</span><span class="n">total</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="mf">44.00</span><span class="o">%</span>
</code></pre></div></td></tr></table></div>
<p>We can also use this decorator to help model expected damage from a single attack in
d20-like role playing games.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">expected_dmg_from_attack_roll</span><span class="p">(</span><span class="n">dmg_h</span><span class="p">,</span> <span class="n">dmg_bonus</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="o">...</span>   <span class="n">normal_dmg</span> <span class="o">=</span> <span class="n">dmg_h</span> <span class="o">+</span> <span class="n">dmg_bonus</span>
<span class="o">...</span>   <span class="n">crit_dmg</span> <span class="o">=</span> <span class="mi">2</span><span class="nd">@dmg_h</span> <span class="o">+</span> <span class="n">dmg_bonus</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="nd">@expandable</span>
<span class="o">...</span>   <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">attack</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">attack</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">return</span> <span class="n">crit_dmg</span>
<span class="o">...</span>     <span class="k">elif</span> <span class="n">attack</span><span class="o">.</span><span class="n">outcome</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">return</span> <span class="n">normal_dmg</span>
<span class="o">...</span>     <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>       <span class="k">return</span> <span class="mi">0</span>
<span class="o">...</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">_expand</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">expected_dmg_from_attack_roll</span><span class="p">(</span><span class="n">dmg_h</span><span class="o">=</span><span class="n">H</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">dmg_bonus</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">avg</span> <span class="o">|</span>    <span class="mf">2.15</span>
<span class="n">std</span> <span class="o">|</span>    <span class="mf">3.40</span>
<span class="n">var</span> <span class="o">|</span>   <span class="mf">11.55</span>
  <span class="mi">0</span> <span class="o">|</span>  <span class="mf">65.00</span><span class="o">%</span> <span class="o">|</span><span class="c1">##################################################</span>
  <span class="mi">2</span> <span class="o">|</span>   <span class="mf">3.75</span><span class="o">%</span> <span class="o">|</span><span class="c1">##</span>
  <span class="mi">3</span> <span class="o">|</span>   <span class="mf">3.83</span><span class="o">%</span> <span class="o">|</span><span class="c1">##</span>
  <span class="mi">4</span> <span class="o">|</span>   <span class="mf">3.91</span><span class="o">%</span> <span class="o">|</span><span class="c1">###</span>
  <span class="mi">5</span> <span class="o">|</span>   <span class="mf">3.98</span><span class="o">%</span> <span class="o">|</span><span class="c1">###</span>
  <span class="mi">6</span> <span class="o">|</span>   <span class="mf">4.06</span><span class="o">%</span> <span class="o">|</span><span class="c1">###</span>
  <span class="mi">7</span> <span class="o">|</span>   <span class="mf">4.14</span><span class="o">%</span> <span class="o">|</span><span class="c1">###</span>
  <span class="mi">8</span> <span class="o">|</span>   <span class="mf">4.22</span><span class="o">%</span> <span class="o">|</span><span class="c1">###</span>
  <span class="mi">9</span> <span class="o">|</span>   <span class="mf">4.30</span><span class="o">%</span> <span class="o">|</span><span class="c1">###</span>
 <span class="mi">10</span> <span class="o">|</span>   <span class="mf">0.62</span><span class="o">%</span> <span class="o">|</span>
 <span class="mi">11</span> <span class="o">|</span>   <span class="mf">0.55</span><span class="o">%</span> <span class="o">|</span>
 <span class="mi">12</span> <span class="o">|</span>   <span class="mf">0.47</span><span class="o">%</span> <span class="o">|</span>
 <span class="mi">13</span> <span class="o">|</span>   <span class="mf">0.39</span><span class="o">%</span> <span class="o">|</span>
 <span class="mi">14</span> <span class="o">|</span>   <span class="mf">0.31</span><span class="o">%</span> <span class="o">|</span>
 <span class="mi">15</span> <span class="o">|</span>   <span class="mf">0.23</span><span class="o">%</span> <span class="o">|</span>
 <span class="mi">16</span> <span class="o">|</span>   <span class="mf">0.16</span><span class="o">%</span> <span class="o">|</span>
 <span class="mi">17</span> <span class="o">|</span>   <span class="mf">0.08</span><span class="o">%</span> <span class="o">|</span>
</code></pre></div></td></tr></table></div>
<div class="admonition info">
<p class="admonition-title">On the current implementation</p>
<p>This decorator relies on <a href="https://docs.python.org/3/library/contextvars.html">context
variables</a> for enforcing
limits without requiring decorated functions to explicitly propagate additional
state.</p>
</div>
<div class="footnote">
<hr />
<ol>
<li id="dyce.evaluation.expandable--fn:1">
<p>An integral <em>limit</em> in the low-to-mid single digits is often more than
sufficient to exceed a useful precision. Consider starting small and edging up
incrementally to avoid protracted execution times. Consider:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nd">@expandable</span>
<span class="o">...</span> <span class="k">def</span> <span class="nf">wicked_explode</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">):</span>
<span class="o">...</span>     <span class="c1"># Replace a high roll with two recursively exploding dice</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">wicked_explode</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="n">wicked_explode</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
<span class="o">...</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">wicked_explode</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Likelihood of making </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">h</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">)]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">h</span><span class="o">.</span><span class="n">total</span><span class="si">:</span><span class="s2">.50%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">Likelihood</span> <span class="n">of</span> <span class="n">making</span> <span class="mi">160</span><span class="p">:</span> <span class="mf">0.00000000000000000000000000000000000000000000000947</span><span class="o">%</span>
</code></pre></div></td></tr></table></div>
<p>The above <em>limit</em> is tolerable for modern computing devices, but much more might
render it intractable.&#160;<a class="footnote-backref" href="#dyce.evaluation.expandable--fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>

          <details class="quote">
            <summary>Source code in <code>dyce/evaluation.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@experimental</span>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">expandable</span><span class="p">(</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DependentTermT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">sentinel</span><span class="p">:</span> <span class="n">H</span> <span class="o">=</span> <span class="n">_DEFAULT_SENTINEL</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_DependentTermT</span><span class="p">],</span> <span class="n">_ForEachEvaluatorT</span><span class="p">],</span> <span class="n">_ForEachEvaluatorT</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    !!! warning &quot;Experimental&quot;</span>

<span class="sd">        This function should be considered experimental and may change or disappear in</span>
<span class="sd">        future versions.</span>

<span class="sd">    Calls ``#!python dependent_term`` for each set of outcomes from the product of any</span>
<span class="sd">    independent sources provided to the decorated function and accumulates the results.</span>
<span class="sd">    Independent sources are [``H`` objects][dyce.h.H], [``P`` objects][dyce.p.P], or</span>
<span class="sd">    [``PWithSelection`` wrapper objects][dyce.evaluation.PWithSelection]. Results are</span>
<span class="sd">    passed to ``#!python dependent_term`` via</span>
<span class="sd">    [``HResult`` objects][dyce.evaluation.HResult] or</span>
<span class="sd">    [``PResult`` objects][dyce.evaluation.PResult], corresponding to the respective</span>
<span class="sd">    independent term. This is useful for resolving dependent probabilities. Returned</span>
<span class="sd">    histograms are always reduced to their lowest terms.</span>

<span class="sd">    For example, let’s say we’re rolling a d20 but want to re-roll a ``#!python 1`` if</span>
<span class="sd">    it comes up, then keep the result.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from dyce import H</span>
<span class="sd">    &gt;&gt;&gt; from dyce.evaluation import HResult, expandable</span>

<span class="sd">    &gt;&gt;&gt; @expandable</span>
<span class="sd">    ... def reroll_on_one(h_result: HResult):</span>
<span class="sd">    ...   if h_result.outcome == 1:</span>
<span class="sd">    ...     return h_result.h</span>
<span class="sd">    ...   else:</span>
<span class="sd">    ...     return h_result.outcome</span>

<span class="sd">    &gt;&gt;&gt; reroll_on_one(H(20))</span>
<span class="sd">    H({1: 1,</span>
<span class="sd">     2: 21,</span>
<span class="sd">     3: 21,</span>
<span class="sd">     4: 21,</span>
<span class="sd">     ...,</span>
<span class="sd">     18: 21,</span>
<span class="sd">     19: 21,</span>
<span class="sd">     20: 21})</span>
<span class="sd">    &gt;&gt;&gt; reroll_on_one(H(6))</span>
<span class="sd">    H({1: 1, 2: 7, 3: 7, 4: 7, 5: 7, 6: 7})</span>

<span class="sd">    ```</span>

<span class="sd">    When the decorated function returns an [``H`` object][dyce.h.H], that histogram’s</span>
<span class="sd">    outcomes are accumulated, but the counts retain their “scale” within the context of</span>
<span class="sd">    the evaluation. This becomes clearer when there is no overlap between the evaluated</span>
<span class="sd">    histogram and the other outcomes.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; d6 = H(6)</span>
<span class="sd">    &gt;&gt;&gt; d00 = (H(10) - 1) * 10 ; d00</span>
<span class="sd">    H({0: 1, 10: 1, 20: 1, 30: 1, 40: 1, 50: 1, 60: 1, 70: 1, 80: 1, 90: 1})</span>
<span class="sd">    &gt;&gt;&gt; set(d6) &amp; set(d00) == set()  # no outcomes in common</span>
<span class="sd">    True</span>

<span class="sd">    &gt;&gt;&gt; @expandable</span>
<span class="sd">    ... def roll_d00_on_one(h_result: HResult):</span>
<span class="sd">    ...   # If a 1 comes up when rolling the d6,</span>
<span class="sd">    ...   # roll a d00 and take that result instead</span>
<span class="sd">    ...   return d00 if h_result.outcome == 1 else h_result.outcome</span>

<span class="sd">    &gt;&gt;&gt; d6_d00 = roll_d00_on_one(d6) ; d6_d00</span>
<span class="sd">    H({0: 1,</span>
<span class="sd">     2: 10,</span>
<span class="sd">     3: 10,</span>
<span class="sd">     4: 10,</span>
<span class="sd">     5: 10,</span>
<span class="sd">     6: 10,</span>
<span class="sd">     10: 1,</span>
<span class="sd">     20: 1,</span>
<span class="sd">     30: 1,</span>
<span class="sd">     40: 1,</span>
<span class="sd">     50: 1,</span>
<span class="sd">     60: 1,</span>
<span class="sd">     70: 1,</span>
<span class="sd">     80: 1,</span>
<span class="sd">     90: 1})</span>

<span class="sd">    ```</span>

<span class="sd">    Note that the sum of the outcomes’ counts from the d00 make up the same</span>
<span class="sd">    proportion as the one’s outcome and count they replaced from the d6.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; Fraction(</span>
<span class="sd">    ...   sum(count for outcome, count in d6_d00.items() if outcome in d00),</span>
<span class="sd">    ...   d6_d00.total,</span>
<span class="sd">    ... )</span>
<span class="sd">    Fraction(1, 6)</span>
<span class="sd">    &gt;&gt;&gt; Fraction(d6[1], d6.total)</span>
<span class="sd">    Fraction(1, 6)</span>

<span class="sd">    ```</span>

<span class="sd">    We can leverage this to compute distributions for an “exploding” die (i.e.,</span>
<span class="sd">    re-rolling and adding when rolling its highest face).</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; @expandable</span>
<span class="sd">    ... def explode_once(h_result: HResult):</span>
<span class="sd">    ...   if h_result.outcome == max(h_result.h):</span>
<span class="sd">    ...     return h_result.h + h_result.outcome</span>
<span class="sd">    ...   else:</span>
<span class="sd">    ...     return h_result.outcome</span>

<span class="sd">    &gt;&gt;&gt; explode_once(H(6))</span>
<span class="sd">    H({1: 6, 2: 6, 3: 6, 4: 6, 5: 6, 7: 1, 8: 1, 9: 1, 10: 1, 11: 1, 12: 1})</span>
<span class="sd">    &gt;&gt;&gt; explode_once(H(20))</span>
<span class="sd">    H({1: 20,</span>
<span class="sd">       2: 20,</span>
<span class="sd">       ...,</span>
<span class="sd">       18: 20,</span>
<span class="sd">       19: 20,</span>
<span class="sd">       21: 1,</span>
<span class="sd">       22: 1,</span>
<span class="sd">       ...,</span>
<span class="sd">       39: 1,</span>
<span class="sd">       40: 1})</span>

<span class="sd">    ```</span>

<span class="sd">    ``#!python @expandable`` functions can call themselves recursively. They take a</span>
<span class="sd">    *limit* keyword argument to control when such recursion should stop. The decorator</span>
<span class="sd">    itself takes an optional argument *sentinel*, which defines what is returned once</span>
<span class="sd">    *limit* is reached (or a ``#!python RecursionError`` is encountered, whichever comes</span>
<span class="sd">    first). The default value for *sentinel* is ``#!python H({0: 1})`` and the value</span>
<span class="sd">    ascribed to *limit*, if not provided, is ``#!python 1``.</span>

<span class="sd">    If *limit* is a whole number, it defines the maximum recursive evaluation “depth”.</span>
<span class="sd">    The way to express no recursion (i.e., merely return *sentinel*) is to set *limit*</span>
<span class="sd">    to an integral value of ``#!python 0``. An integral value of ``#!python -1`` is</span>
<span class="sd">    equivalent to setting it to ``#!python sys.maxsize``.[^1]</span>

<span class="sd">    [^1]:</span>

<span class="sd">        An integral *limit* in the low-to-mid single digits is often more than</span>
<span class="sd">        sufficient to exceed a useful precision. Consider starting small and edging up</span>
<span class="sd">        incrementally to avoid protracted execution times. Consider:</span>

<span class="sd">        ``` python</span>
<span class="sd">        &gt;&gt;&gt; @expandable</span>
<span class="sd">        ... def wicked_explode(h_result: HResult):</span>
<span class="sd">        ...   if h_result.outcome == max(h_result.h):</span>
<span class="sd">        ...     # Replace a high roll with two recursively exploding dice</span>
<span class="sd">        ...     return wicked_explode(h_result.h) + wicked_explode(h_result.h)</span>
<span class="sd">        ...   else:</span>
<span class="sd">        ...     return h_result.outcome</span>

<span class="sd">        &gt;&gt;&gt; h = wicked_explode(H(6), limit=6)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Likelihood of making {max(h)}: {h[max(h)] / h.total:.50%}&quot;)</span>
<span class="sd">        Likelihood of making 160: 0.00000000000000000000000000000000000000000000000947%</span>

<span class="sd">        ```</span>

<span class="sd">        The above *limit* is tolerable for modern computing devices, but much more might</span>
<span class="sd">        render it intractable.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; def explode_recursive(h: H, limit=None) -&gt; H:</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @expandable(sentinel=h)  # return the original histogram at the recursion limit</span>
<span class="sd">    ...   def _expand(h_result: HResult):</span>
<span class="sd">    ...     return _expand(h_result.h) + h_result.outcome if h_result.outcome == max(h_result.h) else h_result.outcome</span>
<span class="sd">    ...</span>
<span class="sd">    ...   return _expand(h, limit=limit)</span>

<span class="sd">    &gt;&gt;&gt; explode_recursive(H(6), limit=1) == explode_once(H(6))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; explode_recursive(H(6), limit=0) == H(6)  # return the sentinel without evaluation</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; exploded_d6_h = explode_recursive(H(6), limit=2) ; exploded_d6_h</span>
<span class="sd">    H({1: 36,</span>
<span class="sd">     2: 36,</span>
<span class="sd">     3: 36,</span>
<span class="sd">     4: 36,</span>
<span class="sd">     5: 36,</span>
<span class="sd">     7: 6,</span>
<span class="sd">     8: 6,</span>
<span class="sd">     9: 6,</span>
<span class="sd">     10: 6,</span>
<span class="sd">     11: 6,</span>
<span class="sd">     13: 1,</span>
<span class="sd">     14: 1,</span>
<span class="sd">     15: 1,</span>
<span class="sd">     16: 1,</span>
<span class="sd">     17: 1,</span>
<span class="sd">     18: 1})</span>

<span class="sd">    ```</span>

<span class="sd">    If *limit* is a fractional value between zero and one, exclusive, recursion will</span>
<span class="sd">    halt on any branch whose “contextual precision” is less than or equal to that value.</span>
<span class="sd">    Recursion is attempted for all of the outcomes of a(n evaluated) histogram or none</span>
<span class="sd">    of them. The contextual precision of a returned histogram is its proportion to the</span>
<span class="sd">    whole.</span>

<span class="sd">    The contextual precision of the original (or top-level) execution is ``#!python</span>
<span class="sd">    Fraction(1, 1)`` or ``#!python 1.0``. A *limit* of either of those values would</span>
<span class="sd">    theoretically ensure no substitution. Similarly, a fractional value for *limit* of</span>
<span class="sd">    ``#!python Fraction(0, 1)`` or ``#!python 0.0`` would theoretically ensure there is</span>
<span class="sd">    no limit. However, These expressions would likely lead to confusion because they</span>
<span class="sd">    have different meanings than equivalent integral values for *limit*. This is why</span>
<span class="sd">    fractional types with values equivalent to zero and one are not allowed.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from fractions import Fraction</span>
<span class="sd">    &gt;&gt;&gt; explode_recursive(H(6), limit=Fraction(1, 6 ** 2)) == exploded_d6_h</span>
<span class="sd">    True</span>

<span class="sd">    ```</span>

<span class="sd">    While whole number *limit* values will always cut off recursion at a constant depth,</span>
<span class="sd">    fractional *limit* values can skew results in favor of certain recursion branches.</span>
<span class="sd">    This is easily demonstrated when examining “unfair” dice (i.e., those</span>
<span class="sd">    disproportionately weighted toward particular faces).</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; explode_recursive(H({1: 1, 2: 19}), limit=3)</span>
<span class="sd">    H({1: 8000, 3: 7600, 5: 7220, 7: 6859, 8: 130321})</span>
<span class="sd">    &gt;&gt;&gt; explode_recursive(H({1: 19, 2: 1}), limit=3)  # same depth</span>
<span class="sd">    H({1: 152000, 3: 7600, 5: 380, 7: 19, 8: 1})</span>

<span class="sd">    &gt;&gt;&gt; explode_recursive(H({1: 1, 2: 19}), limit=Fraction(9, 10))</span>
<span class="sd">    H({1: 8000, 3: 7600, 5: 7220, 7: 6859, 8: 130321})</span>
<span class="sd">    &gt;&gt;&gt; explode_recursive(H({1: 19, 2: 1}), limit=Fraction(9, 10))  # same limit, different depth</span>
<span class="sd">    H({1: 380, 3: 19, 4: 1})</span>

<span class="sd">    ```</span>

<span class="sd">    Be aware that some recursions are guaranteed to result in maxing out the stack, even</span>
<span class="sd">    with fractional values for *limit* that are very close to one. We can often guard</span>
<span class="sd">    against this by short-circuiting recursion where we know the evaluated contextual</span>
<span class="sd">    probabilities do not asymptotically approach zero (e.g., where an entire branch</span>
<span class="sd">    reliably generates histograms with precisely one outcome).</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; def guarded_explode(h: H, limit=None) -&gt; H:</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @expandable(sentinel=h)</span>
<span class="sd">    ...   def _expand(h_result: HResult):</span>
<span class="sd">    ...     if len(h_result.h) == 1:</span>
<span class="sd">    ...       raise ValueError(&quot;cannot explode a histogram with a single outcome&quot;)</span>
<span class="sd">    ...     elif h_result.outcome == max(h_result.h):</span>
<span class="sd">    ...       return _expand(h_result.h) + h_result.outcome</span>
<span class="sd">    ...     else:</span>
<span class="sd">    ...       return h_result.outcome</span>
<span class="sd">    ...</span>
<span class="sd">    ...   return _expand(h, limit=limit)</span>

<span class="sd">    &gt;&gt;&gt; guarded_explode(H(1), limit=Fraction(999_999, 1_000_000))</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">      ...</span>
<span class="sd">    ValueError: cannot explode a histogram with a single outcome</span>

<span class="sd">    ```</span>

<span class="sd">    We can also evaluate multiple independent sources. For example, let’s say we want to</span>
<span class="sd">    understand when a d6 will beat each face on two d10s. We can use a nested function</span>
<span class="sd">    to also allow for a penalty or bonus modifier to the d6.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from dyce import P</span>
<span class="sd">    &gt;&gt;&gt; from dyce.evaluation import PResult</span>
<span class="sd">    &gt;&gt;&gt; p_2d10 = 2@P(10)</span>

<span class="sd">    &gt;&gt;&gt; def times_a_modded_d6_beats_two_d10s(mod: int = 0) -&gt; H:</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @expandable</span>
<span class="sd">    ...   def _expand(d6: HResult, p_2d10: PResult):</span>
<span class="sd">    ...     return sum(1 for outcome in p_2d10.roll if outcome &lt; d6.outcome + mod)</span>
<span class="sd">    ...</span>
<span class="sd">    ...   return _expand(H(6), p_2d10)</span>

<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s()</span>
<span class="sd">    H({0: 71, 1: 38, 2: 11})</span>
<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s(mod=-1)</span>
<span class="sd">    H({0: 43, 1: 14, 2: 3})</span>
<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s(mod=+2)</span>
<span class="sd">    H({0: 199, 1: 262, 2: 139})</span>

<span class="sd">    ```</span>

<span class="sd">    Now let’s say we want to introduce the concept of an “advantage” or “disadvantage”</span>
<span class="sd">    to the above, meaning we roll an extra d10 that can further penalize or benefit us.</span>
<span class="sd">    We *could* just roll 3d10 and look at the best or worst two of each roll.</span>


<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from enum import Enum, auto</span>
<span class="sd">    &gt;&gt;&gt; p_3d10 = 3@P(10)</span>

<span class="sd">    &gt;&gt;&gt; class Advantage(Enum):</span>
<span class="sd">    ...   DISADVANTAGE = auto()</span>
<span class="sd">    ...   NORMAL = auto()</span>
<span class="sd">    ...   ADVANTAGE = auto()</span>

<span class="sd">    &gt;&gt;&gt; def times_a_modded_d6_beats_two_d10s_w_adv_brute_force(mod: int = 0, adv: Advantage = Advantage.NORMAL) -&gt; H:</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @expandable</span>
<span class="sd">    ...   def _expand(d6: HResult, p_d10s: PResult):</span>
<span class="sd">    ...     if adv is Advantage.ADVANTAGE:</span>
<span class="sd">    ...       roll = p_d10s.roll[:2]  # try to beat the worst two values</span>
<span class="sd">    ...     elif adv is Advantage.DISADVANTAGE:</span>
<span class="sd">    ...       roll = p_d10s.roll[-2:]  # try to beat the best two values</span>
<span class="sd">    ...     else:</span>
<span class="sd">    ...       roll = p_d10s.roll</span>
<span class="sd">    ...     return sum(1 for outcome in roll if outcome &lt; d6.outcome + mod)</span>
<span class="sd">    ...</span>
<span class="sd">    ...   if adv is Advantage.NORMAL:</span>
<span class="sd">    ...     return _expand(H(6), p_2d10)</span>
<span class="sd">    ...   else:</span>
<span class="sd">    ...     return _expand(H(6), p_3d10)</span>

<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s_w_adv_brute_force() == times_a_modded_d6_beats_two_d10s()</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s_w_adv_brute_force(adv=Advantage.ADVANTAGE)</span>
<span class="sd">    H({0: 39, 1: 25, 2: 16})</span>
<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s_w_adv_brute_force(adv=Advantage.DISADVANTAGE)</span>
<span class="sd">    H({0: 64, 1: 13, 2: 3})</span>

<span class="sd">    ```</span>

<span class="sd">    However, we could be more computationally more efficient by narrowing our selection</span>
<span class="sd">    before we get to our evaluation function. We do this using</span>
<span class="sd">    [``PWithSelection`` objects][dyce.evaluation.PWithSelection] whose ``#!python</span>
<span class="sd">    PWithSelection.which`` values are passed to the</span>
<span class="sd">    [``P.rolls_with_counts``][dyce.p.P.rolls_with_counts] method when enumerating the</span>
<span class="sd">    rolls.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from dyce.evaluation import PWithSelection</span>

<span class="sd">    &gt;&gt;&gt; def times_a_modded_d6_beats_two_d10s_w_adv(mod: int = 0, adv: Advantage = Advantage.NORMAL) -&gt; H:</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @expandable</span>
<span class="sd">    ...   def _expand(d6: HResult, p_d10s: PResult):</span>
<span class="sd">    ...     return sum(1 for outcome in p_d10s.roll if outcome &lt; d6.outcome + mod)</span>
<span class="sd">    ...</span>
<span class="sd">    ...   if adv is Advantage.ADVANTAGE:</span>
<span class="sd">    ...     return _expand(H(6), PWithSelection(p_3d10, (0, 1)))  # pass only the worst two values</span>
<span class="sd">    ...   elif adv is Advantage.DISADVANTAGE:</span>
<span class="sd">    ...     return _expand(H(6), PWithSelection(p_3d10, (-2, -1)))  # pass only the best two values</span>
<span class="sd">    ...   else:</span>
<span class="sd">    ...     return _expand(H(6), p_2d10)</span>

<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s_w_adv() == times_a_modded_d6_beats_two_d10s()</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s_w_adv(adv=Advantage.ADVANTAGE)</span>
<span class="sd">    H({0: 39, 1: 25, 2: 16})</span>
<span class="sd">    &gt;&gt;&gt; times_a_modded_d6_beats_two_d10s_w_adv(adv=Advantage.DISADVANTAGE)</span>
<span class="sd">    H({0: 64, 1: 13, 2: 3})</span>

<span class="sd">    ```</span>

<span class="sd">    This function uses the [``aggregate_weighted``][dyce.evaluation.aggregate_weighted]</span>
<span class="sd">    function in its implementation. As such, if the empty histogram (``H({})``) is</span>
<span class="sd">    returned at any point, the corresponding branch and its count is omitted from the</span>
<span class="sd">    result without substitution or scaling. A silly example is modeling a d5 by</span>
<span class="sd">    indefinitely re-rolling a d6 until something other than a 6 comes up.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; @expandable</span>
<span class="sd">    ... def omit_6s(h_result: HResult):</span>
<span class="sd">    ...   return H({}) if h_result.outcome == 6 else h_result.outcome</span>

<span class="sd">    &gt;&gt;&gt; omit_6s(H(6))</span>
<span class="sd">    H({1: 1, 2: 1, 3: 1, 4: 1, 5: 1})</span>

<span class="sd">    ```</span>

<span class="sd">    This technique is more useful when modeling re-rolling certain derived outcomes,</span>
<span class="sd">    like ties in a contest.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; @expandable</span>
<span class="sd">    ... def vs(attack: HResult, defend: HResult):</span>
<span class="sd">    ...   return (attack.outcome &gt; defend.outcome) - (attack.outcome &lt; defend.outcome)</span>

<span class="sd">    &gt;&gt;&gt; vs(3@H(6), 2@H(8))</span>
<span class="sd">    H({-1: 4553, 0: 1153, 1: 8118})</span>

<span class="sd">    &gt;&gt;&gt; @expandable</span>
<span class="sd">    ... def vs_reroll_ties(attack: HResult, defend: HResult):</span>
<span class="sd">    ...   res = (attack.outcome &gt; defend.outcome) - (attack.outcome &lt; defend.outcome)</span>
<span class="sd">    ...   return H({}) if res == 0 else res</span>

<span class="sd">    &gt;&gt;&gt; vs_reroll_ties(3@H(6), 2@H(8))</span>
<span class="sd">    H({-1: 4553, 1: 8118})</span>

<span class="sd">    ```</span>

<span class="sd">    Expandables are quite flexible and well suited to modeling logical progressions with</span>
<span class="sd">    dependent variables. Consider the following mechanic:</span>

<span class="sd">      1. Start with a total of zero.</span>

<span class="sd">      2. Roll a six-sided die. If the face was a six, go to step 3. Otherwise, add the</span>
<span class="sd">         face to the total and stop.</span>

<span class="sd">      3. Roll a four-sided die. Add the face to the total. If the face was a one, go to</span>
<span class="sd">         step 2. Otherwise, stop.</span>

<span class="sd">    What is the likelihood of an even final tally? This can be approximated by:</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; def alternating_d6_d4_mechanic(limit=None) -&gt; H:</span>
<span class="sd">    ...   d4, d6 = H(4), H(6)</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @expandable</span>
<span class="sd">    ...   def _expand(h_result: HResult):</span>
<span class="sd">    ...     if h_result.h == d6 and h_result.outcome == 6:</span>
<span class="sd">    ...       return _expand(d4)</span>
<span class="sd">    ...     elif h_result.h == d4 and h_result.outcome == 1:</span>
<span class="sd">    ...       return h_result.outcome + _expand(d6)</span>
<span class="sd">    ...     else:</span>
<span class="sd">    ...       return h_result.outcome</span>
<span class="sd">    ...</span>
<span class="sd">    ...   return _expand(d6, limit=limit)</span>

<span class="sd">    &gt;&gt;&gt; h = alternating_d6_d4_mechanic(limit=Fraction(1, 5_000))</span>
<span class="sd">    &gt;&gt;&gt; print(h.format(scaled=True))</span>
<span class="sd">    avg |    3.04</span>
<span class="sd">    std |    1.37</span>
<span class="sd">    var |    1.87</span>
<span class="sd">      1 |  16.67% |######################################</span>
<span class="sd">      2 |  21.53% |#################################################</span>
<span class="sd">      3 |  21.74% |##################################################</span>
<span class="sd">      4 |  21.74% |##################################################</span>
<span class="sd">      5 |  17.57% |########################################</span>
<span class="sd">      6 |   0.73% |#</span>
<span class="sd">      7 |   0.03% |</span>
<span class="sd">    &gt;&gt;&gt; h_even = h.is_even()</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;{h_even[True] / h_even.total:.2%}&quot;)</span>
<span class="sd">    44.00%</span>

<span class="sd">    ```</span>

<span class="sd">    We can also use this decorator to help model expected damage from a single attack in</span>
<span class="sd">    d20-like role playing games.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; def expected_dmg_from_attack_roll(dmg_h, dmg_bonus, target):</span>
<span class="sd">    ...   normal_dmg = dmg_h + dmg_bonus</span>
<span class="sd">    ...   crit_dmg = 2@dmg_h + dmg_bonus</span>
<span class="sd">    ...</span>
<span class="sd">    ...   @expandable</span>
<span class="sd">    ...   def _expand(attack: HResult):</span>
<span class="sd">    ...     if attack.outcome == 20:</span>
<span class="sd">    ...       return crit_dmg</span>
<span class="sd">    ...     elif attack.outcome &gt;= target:</span>
<span class="sd">    ...       return normal_dmg</span>
<span class="sd">    ...     else:</span>
<span class="sd">    ...       return 0</span>
<span class="sd">    ...</span>
<span class="sd">    ...   return _expand(H(20))</span>

<span class="sd">    &gt;&gt;&gt; h = expected_dmg_from_attack_roll(dmg_h=H(8), dmg_bonus=+1, target=14)</span>
<span class="sd">    &gt;&gt;&gt; print(h.format(scaled=True))</span>
<span class="sd">    avg |    2.15</span>
<span class="sd">    std |    3.40</span>
<span class="sd">    var |   11.55</span>
<span class="sd">      0 |  65.00% |##################################################</span>
<span class="sd">      2 |   3.75% |##</span>
<span class="sd">      3 |   3.83% |##</span>
<span class="sd">      4 |   3.91% |###</span>
<span class="sd">      5 |   3.98% |###</span>
<span class="sd">      6 |   4.06% |###</span>
<span class="sd">      7 |   4.14% |###</span>
<span class="sd">      8 |   4.22% |###</span>
<span class="sd">      9 |   4.30% |###</span>
<span class="sd">     10 |   0.62% |</span>
<span class="sd">     11 |   0.55% |</span>
<span class="sd">     12 |   0.47% |</span>
<span class="sd">     13 |   0.39% |</span>
<span class="sd">     14 |   0.31% |</span>
<span class="sd">     15 |   0.23% |</span>
<span class="sd">     16 |   0.16% |</span>
<span class="sd">     17 |   0.08% |</span>

<span class="sd">    ```</span>

<span class="sd">    !!! info &quot;On the current implementation&quot;</span>

<span class="sd">        This decorator relies on [context</span>
<span class="sd">        variables](https://docs.python.org/3/library/contextvars.html) for enforcing</span>
<span class="sd">        limits without requiring decorated functions to explicitly propagate additional</span>
<span class="sd">        state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_f</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">_POrPWithSelectionOrSourceT</span><span class="p">,</span>
            <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LimitT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">_POrPWithSelectionOrSourceT</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cur_ctxt</span> <span class="o">=</span> <span class="n">_expandable_ctxt</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="n">cur_ctxt</span> <span class="o">=</span> <span class="n">_Context</span><span class="p">()</span>

            <span class="n">callback</span> <span class="o">=</span> <span class="n">f</span>

            <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_norm_limit</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">_DEFAULT_LIMIT</span>
                    <span class="k">if</span> <span class="n">cur_ctxt</span><span class="o">.</span><span class="n">normalized_limit</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="n">_normalize_limit</span><span class="p">(</span><span class="n">cur_ctxt</span><span class="o">.</span><span class="n">normalized_limit</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_norm_limit</span> <span class="o">=</span> <span class="n">_normalize_limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_norm_limit</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">cur_ctxt</span><span class="o">.</span><span class="n">contextual_depth</span> <span class="o">&gt;=</span> <span class="n">new_norm_limit</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_norm_limit</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">cur_ctxt</span><span class="o">.</span><span class="n">contextual_precision</span> <span class="o">&lt;=</span> <span class="n">new_norm_limit</span>
            <span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">sentinel</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Mixing these requires dictionaries&#39; orders to be durable across state</span>
                <span class="c1"># mutations. We&#39;re relying on args and kw to remain constant and</span>
                <span class="c1"># ordered.</span>
                <span class="n">objs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">PWithSelection</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">_source_to_h_or_p_or_p_with_selection</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="p">)</span>

                <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">_expand_if_we_can_can_can</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">HOrOutcomeT</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
                    <span class="k">for</span> <span class="n">result_counts</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
                        <span class="o">*</span><span class="p">(</span>
                            <span class="n">_h_or_p_or_p_with_selection_to_result_iterable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">results</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">result_counts</span><span class="p">)</span>
                        <span class="n">combined_count</span> <span class="o">=</span> <span class="n">prod</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
                        <span class="n">token</span> <span class="o">=</span> <span class="n">_expandable_ctxt</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                            <span class="n">_Context</span><span class="p">(</span>
                                <span class="n">normalized_limit</span><span class="o">=</span><span class="n">new_norm_limit</span><span class="p">,</span>
                                <span class="n">contextual_depth</span><span class="o">=</span><span class="n">cur_ctxt</span><span class="o">.</span><span class="n">contextual_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">contextual_precision</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span>
                                    <span class="n">cur_ctxt</span><span class="o">.</span><span class="n">contextual_precision</span><span class="o">.</span><span class="n">numerator</span>
                                    <span class="o">*</span> <span class="n">combined_count</span><span class="p">,</span>
                                    <span class="n">cur_ctxt</span><span class="o">.</span><span class="n">contextual_precision</span><span class="o">.</span><span class="n">denominator</span> <span class="o">*</span> <span class="n">total</span><span class="p">,</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Remember how we signaled our reliance on the ordering</span>
                            <span class="c1"># above? Here&#39;s why. We&#39;re going to take the first part as</span>
                            <span class="c1"># the args, and the second part as the ordered kw values,</span>
                            <span class="c1"># then zip them back up with the ordered kw keys.</span>
                            <span class="n">callback_args</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span>
                            <span class="n">callback_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">results</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">:]))</span>

                            <span class="c1"># This is either our callback or our sentinel function (if</span>
                            <span class="c1"># we hit our limit above)</span>
                            <span class="n">evaluated</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">*</span><span class="n">callback_args</span><span class="p">,</span> <span class="o">**</span><span class="n">callback_kw</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">RecursionError</span><span class="p">:</span>
                            <span class="c1"># We bottomed out the system stack when calling our</span>
                            <span class="c1"># callback, so return our sentinel</span>
                            <span class="n">evaluated</span> <span class="o">=</span> <span class="n">sentinel</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">_expandable_ctxt</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

                        <span class="k">yield</span> <span class="n">evaluated</span><span class="p">,</span> <span class="n">combined_count</span>

                <span class="n">res</span> <span class="o">=</span> <span class="n">aggregate_weighted</span><span class="p">(</span><span class="n">_expand_if_we_can_can_can</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">cur_ctxt</span><span class="o">.</span><span class="n">contextual_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">lowest_terms</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">res</span>

        <span class="k">return</span> <span class="n">_f</span>

    <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">_decorator</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">else</span> <span class="n">_decorator</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="dyce.evaluation.explode" class="doc doc-heading">
<code class="highlight language-python"><span class="n">explode</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">_SourceT</span><span class="p">,</span> <span class="n">predicate</span><span class="p">:</span> <span class="n">_PredicateT</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">result</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">h</span><span class="p">),</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LimitT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LimitT</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">H</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>This function should be considered experimental and may change or disappear in
future versions.</p>
</div>
<p>Approximates an “exploding” die (i.e., one where a running total is accumulated
and re-rolls are allowed so long as <em>predicate</em> returns <code class="highlight"><span class="kc">True</span></code>).
<em>predicate</em> takes two arguments: <em>outcome</em> is the outcome being considered and <em>h</em>
is the histogram from which it originated. The default <em>predicate</em> returns
<code class="highlight"><span class="kc">True</span></code> if its <em>outcome</em> is <code class="highlight"><span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></code>, and <code class="highlight"><span class="kc">False</span></code>
otherwise. <em>limit</em> shares the same semantics as with the
<a class="autorefs autorefs-internal" href="#dyce.evaluation.expandable"><code>expandable</code> decorator</a>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce.evaluation</span> <span class="kn">import</span> <span class="n">HResult</span><span class="p">,</span> <span class="n">explode</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">2</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">3</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">4</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">5</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
 <span class="mi">7</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">8</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">9</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">10</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">11</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">13</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">14</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">15</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">16</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">17</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">18</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># approximates d20 that explodes when rolling any even number (to a precision of 0.0001 or better)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">is_even_predicate</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">):</span>
<span class="o">...</span>   <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">is_even_predicate</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">160000</span><span class="p">,</span>
 <span class="mi">3</span><span class="p">:</span> <span class="mi">168000</span><span class="p">,</span>
 <span class="mi">5</span><span class="p">:</span> <span class="mi">176400</span><span class="p">,</span>
 <span class="mi">7</span><span class="p">:</span> <span class="mi">185220</span><span class="p">,</span>
 <span class="mi">9</span><span class="p">:</span> <span class="mi">194481</span><span class="p">,</span>
 <span class="mi">10</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">11</span><span class="p">:</span> <span class="mi">204205</span><span class="p">,</span>
 <span class="mi">12</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
 <span class="mi">13</span><span class="p">:</span> <span class="mi">214415</span><span class="p">,</span>
 <span class="mi">14</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
 <span class="mi">15</span><span class="p">:</span> <span class="mi">225135</span><span class="p">,</span>
 <span class="o">...</span><span class="p">,</span>
 <span class="mi">95</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
 <span class="mi">96</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
 <span class="mi">97</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
 <span class="mi">98</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
 <span class="mi">99</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">100</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<p>Where <em>h</em> has a single outcome that satisfies <em>predicate</em> and <em>limit</em> is a
fractional value, this function returns special histograms, possibly leveraging the
<em>inf</em> parameter. The default for <em>inf</em> is <code class="highlight"><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span></code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">is_even_predicate</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">))</span>  <span class="c1"># returns h</span>
<span class="n">H</span><span class="p">({</span><span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">is_even_predicate</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">))</span>  <span class="c1"># extrapolated to positive infinity</span>
<span class="n">H</span><span class="p">({</span><span class="n">inf</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">is_even_predicate</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">))</span>  <span class="c1"># returns h</span>
<span class="n">H</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">is_even_predicate</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">))</span>  <span class="c1"># extrapolated to negative infinity</span>
<span class="n">H</span><span class="p">({</span><span class="o">-</span><span class="n">inf</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">is_even_predicate</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">),</span> <span class="n">inf</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="n">H</span><span class="p">({</span><span class="o">-</span><span class="mi">2000000</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sympy</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">sympify</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">explode</span><span class="p">(</span><span class="n">H</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">limit</span><span class="o">=</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="n">oo</span><span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>

          <details class="quote">
            <summary>Source code in <code>dyce/evaluation.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@experimental</span>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">explode</span><span class="p">(</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">_SourceT</span><span class="p">,</span>
    <span class="n">predicate</span><span class="p">:</span> <span class="n">_PredicateT</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">result</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">h</span><span class="p">),</span>
    <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LimitT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">inf</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    !!! warning &quot;Experimental&quot;</span>

<span class="sd">        This function should be considered experimental and may change or disappear in</span>
<span class="sd">        future versions.</span>

<span class="sd">    Approximates an “exploding” die (i.e., one where a running total is accumulated</span>
<span class="sd">    and re-rolls are allowed so long as *predicate* returns ``#!python True``).</span>
<span class="sd">    *predicate* takes two arguments: *outcome* is the outcome being considered and *h*</span>
<span class="sd">    is the histogram from which it originated. The default *predicate* returns</span>
<span class="sd">    ``#!python True`` if its *outcome* is ``#!python max(h)``, and ``#!python False``</span>
<span class="sd">    otherwise. *limit* shares the same semantics as with the</span>
<span class="sd">    [``expandable`` decorator][dyce.evaluation.expandable].</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from dyce.evaluation import HResult, explode</span>
<span class="sd">    &gt;&gt;&gt; explode(H(6), limit=2)</span>
<span class="sd">    H({1: 36,</span>
<span class="sd">     2: 36,</span>
<span class="sd">     3: 36,</span>
<span class="sd">     4: 36,</span>
<span class="sd">     5: 36,</span>
<span class="sd">     7: 6,</span>
<span class="sd">     8: 6,</span>
<span class="sd">     9: 6,</span>
<span class="sd">     10: 6,</span>
<span class="sd">     11: 6,</span>
<span class="sd">     13: 1,</span>
<span class="sd">     14: 1,</span>
<span class="sd">     15: 1,</span>
<span class="sd">     16: 1,</span>
<span class="sd">     17: 1,</span>
<span class="sd">     18: 1})</span>

<span class="sd">    &gt;&gt;&gt; from fractions import Fraction</span>
<span class="sd">    &gt;&gt;&gt; # approximates d20 that explodes when rolling any even number (to a precision of 0.0001 or better)</span>

<span class="sd">    &gt;&gt;&gt; def is_even_predicate(h_result: HResult):</span>
<span class="sd">    ...   return h_result.outcome % 2 == 0</span>

<span class="sd">    &gt;&gt;&gt; explode(H(20), is_even_predicate, limit=Fraction(1, 10_000))</span>
<span class="sd">    H({1: 160000,</span>
<span class="sd">     3: 168000,</span>
<span class="sd">     5: 176400,</span>
<span class="sd">     7: 185220,</span>
<span class="sd">     9: 194481,</span>
<span class="sd">     10: 1,</span>
<span class="sd">     11: 204205,</span>
<span class="sd">     12: 5,</span>
<span class="sd">     13: 214415,</span>
<span class="sd">     14: 15,</span>
<span class="sd">     15: 225135,</span>
<span class="sd">     ...,</span>
<span class="sd">     95: 15,</span>
<span class="sd">     96: 15,</span>
<span class="sd">     97: 5,</span>
<span class="sd">     98: 5,</span>
<span class="sd">     99: 1,</span>
<span class="sd">     100: 1})</span>

<span class="sd">    ```</span>

<span class="sd">    Where *h* has a single outcome that satisfies *predicate* and *limit* is a</span>
<span class="sd">    fractional value, this function returns special histograms, possibly leveraging the</span>
<span class="sd">    *inf* parameter. The default for *inf* is ``#!python float(&quot;inf&quot;)``.</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; explode(H({3: 1}), is_even_predicate, limit=Fraction(1, 10_000))  # returns h</span>
<span class="sd">    H({3: 1})</span>
<span class="sd">    &gt;&gt;&gt; explode(H({2: 1}), is_even_predicate, limit=Fraction(1, 10_000))  # extrapolated to positive infinity</span>
<span class="sd">    H({inf: 1})</span>
<span class="sd">    &gt;&gt;&gt; explode(H({0: 1}), is_even_predicate, limit=Fraction(1, 10_000))  # returns h</span>
<span class="sd">    H({0: 1})</span>
<span class="sd">    &gt;&gt;&gt; explode(H({-2: 1}), is_even_predicate, limit=Fraction(1, 10_000))  # extrapolated to negative infinity</span>
<span class="sd">    H({-inf: 1})</span>
<span class="sd">    &gt;&gt;&gt; explode(H({-2: 1}), is_even_predicate, limit=Fraction(1, 10_000), inf=1_000_000)</span>
<span class="sd">    H({-2000000: 1})</span>

<span class="sd">    ```</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; import sympy</span>
<span class="sd">    &gt;&gt;&gt; x = sympy.sympify(&quot;x&quot;)</span>
<span class="sd">    &gt;&gt;&gt; explode(H({x: 1}), limit=Fraction(1, 10_000))</span>
<span class="sd">    H({oo*x: 1})</span>

<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">source</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span> <span class="k">else</span> <span class="n">H</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="nd">@expandable</span><span class="p">(</span><span class="n">sentinel</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_explode</span><span class="p">(</span><span class="n">h_result</span><span class="p">:</span> <span class="n">HResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HOrOutcomeT</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">h_result</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">limit</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">IntegralLike</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">==</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span> <span class="o">-</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">H</span><span class="p">({</span><span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">H</span><span class="p">({</span><span class="n">inf</span> <span class="o">*</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_explode</span><span class="p">(</span><span class="n">h_result</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">h_result</span><span class="o">.</span><span class="n">outcome</span>

    <span class="k">return</span> <span class="n">_explode</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="dyce.evaluation.foreach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">foreach</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">_DependentTermT</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">_POrPWithSelectionOrSourceT</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LimitT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">:</span> <span class="n">H</span> <span class="o">=</span> <span class="n">_DEFAULT_SENTINEL</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">_POrPWithSelectionOrSourceT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>This function should be considered experimental and may change or disappear in
future versions.</p>
</div>
<p>Shorthand for <code class="highlight"><span class="n">expandable</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">sentinel</span><span class="o">=</span><span class="n">sentinel</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span></code>.</p>
<p>Many common cases do not need the full flexibility of the
<a class="autorefs autorefs-internal" href="#dyce.evaluation.expandable"><code>expandable</code></a>. This wrapper that strives to be
simpler or more readable under those circumstances (e.g., where the callback is a
<code class="highlight"><span class="k">lambda</span></code> function).</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">dyce.evaluation</span> <span class="kn">import</span> <span class="n">foreach</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foreach</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d8</span><span class="p">,</span> <span class="n">d12</span><span class="p">:</span> <span class="n">d8</span><span class="o">.</span><span class="n">outcome</span> <span class="o">+</span> <span class="n">d12</span><span class="o">.</span><span class="n">outcome</span><span class="p">,</span> <span class="n">d8</span><span class="o">=</span><span class="n">H</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">d12</span><span class="o">=</span><span class="n">H</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<span class="n">H</span><span class="p">({</span><span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="mi">3</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
 <span class="mi">4</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
 <span class="mi">5</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
 <span class="mi">6</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
 <span class="mi">7</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">8</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
 <span class="mi">9</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
 <span class="mi">10</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
 <span class="mi">11</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
 <span class="mi">12</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
 <span class="mi">13</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
 <span class="mi">14</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
 <span class="mi">15</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
 <span class="mi">16</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
 <span class="mi">17</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
 <span class="mi">18</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
 <span class="mi">19</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
 <span class="mi">20</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>

          <details class="quote">
            <summary>Source code in <code>dyce/evaluation.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@experimental</span>
<span class="nd">@beartype</span>
<span class="k">def</span> <span class="nf">foreach</span><span class="p">(</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">_DependentTermT</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">_POrPWithSelectionOrSourceT</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LimitT</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sentinel</span><span class="p">:</span> <span class="n">H</span> <span class="o">=</span> <span class="n">_DEFAULT_SENTINEL</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">_POrPWithSelectionOrSourceT</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">H</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    !!! warning &quot;Experimental&quot;</span>

<span class="sd">        This function should be considered experimental and may change or disappear in</span>
<span class="sd">        future versions.</span>

<span class="sd">    Shorthand for ``#!python expandable(callback, sentinel=sentinel)(*args, limit=limit,</span>
<span class="sd">    **kw)``.</span>

<span class="sd">    Many common cases do not need the full flexibility of the</span>
<span class="sd">    [``expandable``][dyce.evaluation.expandable]. This wrapper that strives to be</span>
<span class="sd">    simpler or more readable under those circumstances (e.g., where the callback is a</span>
<span class="sd">    ``#!python lambda`` function).</span>

<span class="sd">    ``` python</span>
<span class="sd">    &gt;&gt;&gt; from dyce.evaluation import foreach</span>
<span class="sd">    &gt;&gt;&gt; foreach(lambda d8, d12: d8.outcome + d12.outcome, d8=H(8), d12=H(12))</span>
<span class="sd">    H({2: 1,</span>
<span class="sd">     3: 2,</span>
<span class="sd">     4: 3,</span>
<span class="sd">     5: 4,</span>
<span class="sd">     6: 5,</span>
<span class="sd">     7: 6,</span>
<span class="sd">     8: 7,</span>
<span class="sd">     9: 8,</span>
<span class="sd">     10: 8,</span>
<span class="sd">     11: 8,</span>
<span class="sd">     12: 8,</span>
<span class="sd">     13: 8,</span>
<span class="sd">     14: 7,</span>
<span class="sd">     15: 6,</span>
<span class="sd">     16: 5,</span>
<span class="sd">     17: 4,</span>
<span class="sd">     18: 3,</span>
<span class="sd">     19: 2,</span>
<span class="sd">     20: 1})</span>

<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">expandable</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">sentinel</span><span class="o">=</span><span class="n">sentinel</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <i>Copyright and other protections apply. Please see the accompanying <tt>LICENSE</tt> file for rights and restrictions governing use of this software. All rights not expressly waived or licensed are reserved. If that file is missing or appears to be modified from its original, then please contact the author before viewing or using this software in any capacity.</i>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.tabs.link", "navigation.foreach", "navigation.sections", "toc.integrate"], "search": "../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.220ee61c.min.js"></script>
      
        
          <script src="../js/site.js"></script>
        
      
        
          <script src="../js/mathjax.js"></script>
        
      
        
          <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        
      
        
          <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
      
    
  </body>
</html>